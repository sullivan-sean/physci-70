<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Week 10 - PHYSCI 70: Digital Fabrication</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://seansullivan.ai/physci-70/post/week10/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/combined-min.css">
  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/custom.css">
  

</head>
<body class="">
  <div class="page-container">

<div class="site-wrap">
  <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Week 10 - PHYSCI 70: Digital Fabrication</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://seansullivan.ai/physci-70/post/week10/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/combined-min.css">
  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/custom.css">
  

</head>
<body class="">
  <div class="page-container">

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1>Week 10</h1>
        <span class="post-meta">Apr 13, 2020</span><br>
        
      </div>

      <article class="post-content">
      <h2 id="workout-tracking">Workout Tracking</h2>
<p>With plenty of time during quarantine to establish a consistent workout,
I decided to build a workout tracker this week. Okay, workout tracker
might be a bit of an overstatement. I built a simple force sensitive
sensor that connects to a web app I&rsquo;m running on my computer to log
various forces over time. I used this to record me jump roping (one of my
favorite workouts) as I typically do not have an easy way to objectively
measure reps or intensity day over day.</p>
<h2 id="the-circuit">The Circuit</h2>
<p>I had a force sensitive
resistor from an old electronics kit. This sensor works in a similar way
to a thermistor in that the resistance varies depending on, in this case,
force applied. While the sensor is not precise at quantifying the force
that is put on it, it can measure relative force, which is sufficient for
this application. The sensor consists of two capacitative plates separated
by a spacer that allows the plates to get closer when force is applied.
The circuit to use this sensor was remarkably simple.</p>
<p>The only elements I needed were the sensor and
a $200\Omega$ resistor (the resistance of this resistor doesn&rsquo;t matter but
I chose a small value to measure a larger range of forces).</p>
<p>Using
<a href="https://www.instructables.com/id/Interfacing-Force-Sensitive-Resistor-to-Arduino/">this</a>
guide I found the easiest way to use the force sensor was like this:</p>
<p><img src="../../img/week10/circuit_diagram.jpg" alt="circuit_diagram"></p>
<p>Note that this circuit is a voltage divider that replaces one of the
resistors with the variable force sensitive resistor. The variable voltage
split will then allow us to measure the force at one of the pins.
Analyzing this circuit we find:</p>
<p>$$V_{out} = 3.3 V \cdot 200\Omega / (200\Omega + R)$$</p>
<p>The resistance of the resistor decreases as the capacitative plates come
closer with more force, which causes the output voltage to increase.</p>
<h2 id="the-code">The Code</h2>
<p>With the circuit set up I needed to find a way to log the data from the
force sensor. With the quarantine, I will be jump roping at home. The main
draw of using WiFi/Bluetooth for my recording is to have an automatic and
persistent method of recording. An alternative that would be less
convenient but wouldn&rsquo;t require networking would be to store the data on
the microcontroller in an array and then upload it to my computer. Because
I will be jump roping at home, I decided to set up my web app to receive
the data locally, instead of having to sign up for an API. If I ever want
to take my workout tracker away from home, I could possibly use
<a href="ngrok.io">ngrok</a>, which will introduce a tunnel to the localhost address
of my Flask server.</p>
<p>In the simple case, the Huzzah board would POST data to a route in
a simple Flask server I had set up on my desktop. The Flask server will
then store these results in a sqlite3 database. With this data stored
I can use a fourier transform to find the frequency of my jumps and can
also count peaks above a certain threshold of force to count number of
jumps. Because this data is persistent I can also chart progress over time.</p>
<p>On the Arduino end, the code simply connects to wifi and stores data
throughout the loop over 10ms intervals:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;WiFi.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;HTTPClient.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ArduinoJson.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> force_sensor <span style="color:#f92672">=</span> A2;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ssid <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Your WIFI Network Name&#34;</span>;
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> password <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;Your WIFI Network Password&#34;</span>;
 
<span style="color:#66d9ef">const</span> String server <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Your Server Address&#34;</span>;
<span style="color:#66d9ef">const</span> String route <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/data&#34;</span>;

<span style="color:#75715e">// create JSON array to store data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> LEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
<span style="color:#66d9ef">long</span> data[LEN];
<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#75715e">// Returns array of long data as stringified json object {&#34;data&#34;: []}
</span><span style="color:#75715e"></span>String <span style="color:#a6e22e">stringify</span>(<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> longData, <span style="color:#66d9ef">int</span> len) {
  DynamicJsonDocument doc(len <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>);
  JsonObject obj <span style="color:#f92672">=</span> doc.to<span style="color:#f92672">&lt;</span>JsonObject<span style="color:#f92672">&gt;</span>();
  JsonArray data <span style="color:#f92672">=</span> obj.createNestedArray(<span style="color:#e6db74">&#34;data&#34;</span>);

  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len; i<span style="color:#f92672">++</span>) {
    data.add(longData[i]);
  }

  String postData;
  serializeJson(doc, postData);
  <span style="color:#66d9ef">return</span> postData;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
  Serial.begin(<span style="color:#ae81ff">115200</span>);

  WiFi.begin(ssid, password);

  <span style="color:#66d9ef">while</span> (WiFi.status() <span style="color:#f92672">!=</span> WL_CONNECTED) {
    delay(<span style="color:#ae81ff">1000</span>);
    Serial.println(<span style="color:#e6db74">&#34;Connecting to WiFi..&#34;</span>);
  }

  Serial.println(<span style="color:#e6db74">&#34;Connected to the WiFi network&#34;</span>);

}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
  <span style="color:#66d9ef">int</span> val <span style="color:#f92672">=</span> analogRead(force_sensor);
  data[j] <span style="color:#f92672">=</span> val <span style="color:#f92672">/</span> <span style="color:#ae81ff">4095.0</span>;
  j<span style="color:#f92672">++</span>;
  <span style="color:#75715e">// Send data after collection LEN data points
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (((j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> LEN) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> WiFi.status() <span style="color:#f92672">==</span> WL_CONNECTED) {
    HTTPClient Post;
    Post.begin(server <span style="color:#f92672">+</span> route); 
    Post.addHeader(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>);  
    Post.POST(stringify(data, LEN));
    Post.end();
  }
  delay(<span style="color:#ae81ff">10</span>);
}
</code></pre></div><p>The Flask app is relatively simple as well:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request
<span style="color:#f92672">import</span> json
<span style="color:#f92672">from</span> werkzeug.exceptions <span style="color:#f92672">import</span> BadRequest

app <span style="color:#f92672">=</span> Flask(__name__)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/data&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_route</span>():
    <span style="color:#66d9ef">try</span>:
        data <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get_json()
        <span style="color:#66d9ef">print</span>(data)
    <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">TypeError</span>, BadRequest, <span style="color:#a6e22e">KeyError</span>):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Error&#34;</span>
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Success&#34;</span>
</code></pre></div><p>If you save this file as <code>app.py</code> and run <code>flask run</code> in the same
directory this will start your app on a local server. If you download and
install <a href="https://ngrok.io">ngrok</a> you can then run <code>ngrok http 5000</code> (or
whatever port your flask app is running on) and put the return ngrok url
in as your server address in the Arduino code above. This will expose
a public URL that can be easily accessed by the Arduino even if your
computer and microcontroller are on different wifi networks.</p>

      </article>

      

      
    </div>
  </div>
</div>
    <footer class="footer">
      <div class="wrap">
        <div class="measure mt1 center">
          <small>
            Made by Sean Sullivan, copyright &#169; 2020. Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript" async
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
      });
      MathJax.Hub.Queue(function() {
        
        
        
        var all = MathJax.Hub.getAllJax(), i;
        for(i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });

      MathJax.Hub.Config({
      
      TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
</div>
</body>
</html>

