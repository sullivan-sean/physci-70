<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Week 6 - PHYSCI 70: Digital Fabrication</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://seansullivan.ai/physci-70/post/week6/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/combined-min.css">
  <link rel="stylesheet" type="text/css" href="http://seansullivan.ai/physci-70/css/custom.css">
  

</head>
<body class="">
  <div class="page-container">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://seansullivan.ai/physci-70" class="site-title">PHYSCI 70: Digital Fabrication</a>
      <nav class="site-nav right">
      <a href="http://seansullivan.ai/physci-70/about/">About</a>
<a href="http://seansullivan.ai/physci-70/contact/">Contact</a>
</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1>Week 6</h1>
        <span class="post-meta">Mar 9, 2020</span><br>
        
      </div>

      <article class="post-content">
      <h2 id="electromyography-emg">Electromyography (EMG)</h2>
<p>This week for sensors I wanted to build an electromyogram (EMG) to sense muscle
activation. Inspired by <a href="https://www.theverge.com/2018/6/6/17433516/ctrl-labs-brain-computer-interface-armband-hands-on-preview">CTRL-labs
BCI</a>
that does high precision muscle sensing to preemptively determine how your
hand will move, I thought an EMG would be a good start in learning how
this worked. Muscles are activated through neuronal signaling, which is
electrical. By attaching electrodes to two points of a muscle and
amplifying the signal, you fill find a differential in electrical
potential that changes with muscle contraction. The differential is very
small so it must be amplified and smoothed in order to get good results.</p>
<p>I found an
<a href="https://www.instructables.com/id/Muscle-EMG-Sensor-for-a-Microcontroller/">instructables</a>
with directions for creating an EMG. Though I didn&rsquo;t have nearly all of
the parts for this project, I thought it would be a good exercise in
learning more about some of the circuit components by building them from
constituent parts that I did have.</p>
<p>This guide required two chips that I did not have:</p>
<ul>
<li>INA106: a differential amplifier</li>
<li>TL072: a dual op-amp chip</li>
</ul>
<p>The only op amp I could find in the lab was the OP80 which is a single
op-amp. I found after a few Google searches that it is very feasible to
make a differential amplifier from an op-amp. One problem with this
approach is Given that the project required 1 INA106 and 3 TL072s, I would
need 7 OP80s!! This was going to take up a lot of space on the board.</p>
<p>To get more familiar with operational amplifiers, I tried to get a simple
circuit that amplified voltage from the ItsyBitsy.</p>
<h3 id="op-amps">Op Amps</h3>
<p>I found this helpful <a href="../../img/week6/op-amps.pdf">guide</a> for op-amps.
I followed it to make a non-inverting and inverting amplifier to get used
to all of the pins involved with the OP80 chip, and working with a power
supply in addition to input and output voltage.</p>
<p>Initially, I tried using one 9V battery with a voltage divider to make
a &ldquo;virtual ground&rdquo; that would mimic having two batteries, one positive and
one negative. I was unable to figure out the correct configuration.
I couldn&rsquo;t use 2 9V batteries, however, because the OP80 chip had
a maximum supply voltage rating of $\pm 8V$. Instead I decided to use 2 of
the 5V USB power supplies. To do this, I found two USB cables, cut off the
MicroUSB adapter end and stripped the cable. Inside I found 4 colored
wires. Online I found that these colors meant the following:</p>
<p><img src="../../img/week6/color_codes.jpg" alt="color_codes"></p>
<p>I soldered extension wires onto the positive and negative ends and clipped
the extra length of the data wires:</p>
<p><img src="../../img/week6/usb_hack.jpg" alt="usb_hack"></p>
<p>With two of these in place, I attached the positive terminal of one to the
negative terminal of the other. This connection would serve as my ground,
and the two other terminals would be at $\pm 5V$ relative to ground. This
positive and negative split relative to ground was crucial to the
functioning of the op-amp.</p>
<h4 id="inverting-amplifier">Inverting Amplifier</h4>
<p>Using the guide linked above I first created an
inverting amplifier.</p>
<p>As the name suggests, this circuit inverts the sign of the input voltage
and multiplies it by a number $G$ that is determined by the ratio of the
resistors in the diagram below:</p>
<p><img src="../../img/week6/inverting_diagram.png" alt="inverting_diagram"></p>
<p>The formula here is $V_{out}=-V_{in} (R_2/R_1)$.</p>
<p>I used the analog pin to deliver a small amount of voltage (0.10V) as $V_{in}$ and
measured both this quantity and $V_{out}$ relative to ground. The images
below show these two quantities.</p>
<p><img src="../../img/week6/inverting_in.jpg" alt="inverting_in">
<img src="../../img/week6/inverting_out.jpg" alt="inverting_out"></p>
<p>I used a $10k \Omega$ resistor before $In_{-}$ and a $100k \Omega$
resistor connecting that to the output. This resulted in a theoretical
gain of $-10V$. The readings showed a gain of $-10.8V$, pretty close!</p>
<h4 id="noninverting-amplifier">Noninverting Amplifier</h4>
<p>Next I tried making a noninverting amplifier, which is similar to the
previous example but does not change the sign of the voltage. The diagram
is shown here:</p>
<p><img src="../../img/week6/noninverting_diagram.png" alt="noninverting_diagram"></p>
<p>The formula for $V_{out}$ here is $V_{out}=V_{in} (1 + R_2/R_1)$. I again
constructed the circuit and measured both these quantities with
$V_{in}=0.10V$:</p>
<p><img src="../../img/week6/noninverting_in.jpg" alt="noninverting_in">
<img src="../../img/week6/noninverting_out.jpg" alt="noninverting_out"></p>
<p>The theoretical output voltage should be 1.1V in this case and I measured
$1.19V$. Because both of these voltages were higher than expected there
could be something I&rsquo;m not accounting for in the way I&rsquo;ve set up my
circuit, or my measurement for input voltage didn&rsquo;t show some hanging
decimal that influenced these results after the multiplier.</p>
<h3 id="differential-amplifiers-and-emg">Differential Amplifiers and EMG</h3>
<p>After becoming comfortable with these parts and how they work, I was ready
to start assembling. Going back to the
<a href="https://www.instructables.com/id/Muscle-EMG-Sensor-for-a-Microcontroller/">instructables</a>
site, I started the step by step assembly process they outlined. It was
difficult to follow this guide and I had to do many adaptations because
I lacked the Op-Amps they had. I also had to substitute things like their
$150k \Omega$ resistors for $100k \Omega$ and $47k \Omega$ resistors in
series. The resulting circuit is here:</p>
<p><img src="../../img/week6/full_emg_circuit.jpg" alt="full_emg_circuit"></p>
<p>Each of the op80 chips does something different. The black, yellow and red
wires are the sensor input. Starting from the top
down the op80 chips doe the following:</p>
<ol>
<li>Differential amplification - find difference between electrodes and
amplify with $G=-110$</li>
<li>Inverting amplification - restores the positive sign and amplifies with
$G=14.7$</li>
<li>High pass filter - AC couples the signal and removes DC
offset/low frequency noise</li>
<li>Full-wave rectifier - takes the absolute value of the signal</li>
<li>Part of 4.</li>
<li>Low pass filter - Converts AC signal back to DC, also inverts the signal</li>
<li>Variable inverting amplifier - Uses a potentiometer as variable
resistor for controlled amplification and inversion back to positive voltage</li>
</ol>
<p>While I measured everything with a voltmeter and it worked as expected,
I found the results were just as good with the much simpler circuit here:</p>
<p><img src="../../img/week6/ekg_small_leads.jpg" alt="ekg_small_leads"></p>
<p>This circuit is the same as the above but just takes the differential at
the electrodes and amplifies with $G=1617$. To finally measure the voltage
difference across one of my muscles, I needed to make electrodes.</p>
<p>I first made a little nub to attach an alligator clip to. I made this
(very hackily) from AAA battery holders.</p>
<p><img src="../../img/week6/diy_electrode_nub.jpg" alt="diy_electrode_nub"></p>
<p>With some scotch tape, I had an electrode:</p>
<p><img src="../../img/week6/diy_electrode.jpg" alt="diy_electrode"></p>
<p>To connect this to the circuit, I planned to use alligator clips. I first crimped alligator clips onto wire that I&rsquo;d stripped:</p>
<p><img src="../../img/week6/wire_clip.jpg" alt="wire_clip"></p>
<p>After wiping my arms with sanitary wipes (said on many sites to improve
readings), I connected the circuit to my bicep:</p>
<p><img src="../../img/week6/sanitary.jpg" alt="sanitary"></p>
<p><img src="../../img/week6/circuit_connected.jpg" alt="circuit_connected"></p>
<p>Unfortunately, the reading was much too noisy to indicate any difference
when I flexed vs not. Because directly injecting voltage into the sensor
inputs from the microcontroller resulted in proper amplification,
I concluded this was an issue with my sensors. With proper electrodes,
I hope to get this circuit working.</p>
<h2 id="force-sensor">Force Sensor</h2>
<p>After my lengthy failed attempt at EMG sensing, I created a simpler force
sensor using capacitors:</p>
<p><img src="../../img/week6/force_sensor_circuit.jpg" alt="force_sensor_circuit"></p>
<p>In this circuit, foam separates two capacitative plates. Charge builds up
on the lower plate. The closer the two plates are, the more current that
can flow through them. This draw on current decreases the current flowing
to the input pin allowing us to sense how close the two are.</p>
<p>The readings from the input pin at first had no meaning, so I calibrated
them. For calibration, I added a loop to my setup code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
  Serial.begin(<span style="color:#ae81ff">9600</span>);

  <span style="color:#75715e">// turn on LED to signal the start of the calibration period:
</span><span style="color:#75715e"></span>  pinMode(<span style="color:#ae81ff">13</span>, OUTPUT);
  digitalWrite(<span style="color:#ae81ff">13</span>, HIGH);

  <span style="color:#75715e">// calibrate during the first five seconds
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> (millis() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5000</span>) {
    sensorValue <span style="color:#f92672">=</span> Sensor.capacitiveSensor(<span style="color:#ae81ff">100</span>);

    <span style="color:#75715e">// record the maximum sensor value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (sensorValue <span style="color:#f92672">&gt;</span> sensorMax) {
      sensorMax <span style="color:#f92672">=</span> sensorValue;
    }

    <span style="color:#75715e">// record the minimum sensor value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (sensorValue <span style="color:#f92672">&lt;</span> sensorMin) {
      sensorMin <span style="color:#f92672">=</span> sensorValue;
    }
  }

  <span style="color:#75715e">// signal the end of the calibration period
</span><span style="color:#75715e"></span>  digitalWrite(<span style="color:#ae81ff">13</span>, LOW);
}
</code></pre></div><p>This loop gives 5 seconds where the sensor reads values from the sensor
and sets a max and min value accordingly. In the loop body of my program,
input measures of the capacitive sensor are scaled and clipped to this
range:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
  <span style="color:#66d9ef">long</span> sensorValue <span style="color:#f92672">=</span> Sensor.capacitiveSensor(<span style="color:#ae81ff">10</span>);      <span style="color:#75715e">//Change the number of samples to get the required timing and sensitivity.
</span><span style="color:#75715e"></span>  
  sensorValue <span style="color:#f92672">=</span> map(sensorValue, sensorMin, sensorMax, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>);
  sensorValue <span style="color:#f92672">=</span> constrain(sensorValue, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>);
  analogWrite(<span style="color:#ae81ff">13</span>, sensorValue);


  delay(<span style="color:#ae81ff">10</span>);
  Serial.println(sensorValue);
}
</code></pre></div><p>I output to the serial monitor and then copied this output to a text file
to parse in python and graph:</p>
<p><img src="../../img/week6/force_plot.png" alt="force_plot"></p>
<p>This plot shows the calibrated force voltage reading over time as I first
press lightly and then press all the way down on the top capacitative plate.</p>
<h2 id="temperature-sensor">Temperature Sensor</h2>
<p>The second sensor I built was the temperature sensor. Using a thermistor,
which changes resistance with temperature, I was able to calculate the
ambient temperature of the room. The circuit I built was as follows:</p>
<p><img src="../../img/week6/thermistor.jpg" alt="thermistor"></p>
<p>The black component on the bottom is the thermistor and is connected to
the 3.3V pin and to ground via a resistor. Voltage was read through the A0
pin (though it looks like A1 in the image).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> inputPin <span style="color:#f92672">=</span> A0;
<span style="color:#66d9ef">int</span> voltageReading;
<span style="color:#66d9ef">float</span> R1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100000</span>;
<span style="color:#66d9ef">float</span> thermR;
<span style="color:#66d9ef">float</span> logThermR, T;
<span style="color:#66d9ef">float</span> c1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.009249522e-03</span>, c2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.378405444e-04</span>, c3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.019202697e-07</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
  voltageReading <span style="color:#f92672">=</span> analogRead(inputPin);
  thermR <span style="color:#f92672">=</span> R1 <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1023.0</span> <span style="color:#f92672">/</span> (<span style="color:#66d9ef">float</span>) voltageReading <span style="color:#f92672">-</span> <span style="color:#ae81ff">1.0</span>);

  logThermR <span style="color:#f92672">=</span> log(thermR);
  T <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">/</span> (c1 <span style="color:#f92672">+</span> c2<span style="color:#f92672">*</span>logThermR <span style="color:#f92672">+</span> c3<span style="color:#f92672">*</span>logThermR<span style="color:#f92672">*</span>logThermR<span style="color:#f92672">*</span>logThermR));
  T <span style="color:#f92672">=</span> T <span style="color:#f92672">-</span> <span style="color:#ae81ff">273.15</span>;
  T <span style="color:#f92672">=</span> (T <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.0</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">5.0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">32.0</span>; 

  Serial.println(T);
  delay(<span style="color:#ae81ff">500</span>);
}
</code></pre></div><p>I first calculate the resistance through the thermistor using the iother
resistor and the voltage reading.  Using constants taken from
<a href="https://www.circuitbasics.com/arduino-thermistor-temperature-sensor-tutorial/">this</a>
Arduino thermistor tutorial, I was able to devise a formula for the
temperature in terms of the thermistor&rsquo;s resistance and then convert this
value to Fahrenheit. I again output this to the serial monitor and plotted
the results:</p>
<p><img src="../../img/week6/temp_plot.png" alt="temp_plot"></p>
<p>In order to test it was working, while plotting, I first grabbed the
thermistor which increased the temperature because I was warmer than the
ambient temperature. There was a bottle of compressed air lying around so
I also sprayed this at the thermistor which made it much cooler. Doing
these two things in succession resulted in the graph shown. If I had an
accurate way of measuring temperature, e.g. a thermometer, I could have
better calibrated this sensor as well like in the previous example.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Though my EMG project did not work in the end, I learned more about
circuitry from this attempt than the sum of my knowledge up to this point.
I feel much more comfortable with a multimeter and oscilloscope, have
memorized several resistor color code patterns, and have become a pro at
wire stripping. It was cool and fun to come up with makeshift replacements
for parts I did not have from the tutorial, including the electrodes. This
first iteration did not discourage me but got me really excited about
electronics. I feel much more comfortable and fluent in electronics terms
as well now having learned about so many of the circuit components.</p>

      </article>

      

      

    </div>
  </div>
</div>
    <footer class="footer">
      <div class="wrap">
        <div class="measure mt1 center">
          <small>
            Made by Sean Sullivan, copyright &#169; 2020. Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript" async
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
      });
      MathJax.Hub.Queue(function() {
        
        
        
        var all = MathJax.Hub.getAllJax(), i;
        for(i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });

      MathJax.Hub.Config({
      
      TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
</div>
</body>
</html>

